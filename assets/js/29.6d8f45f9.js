(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{232:function(s,n,a){"use strict";a.r(n);var e=a(0),r=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"webpack-系列手写模块打包代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#webpack-系列手写模块打包代码"}},[s._v("#")]),s._v(" Webpack 系列手写模块打包代码")]),s._v(" "),a("h2",{attrs:{id:"loader"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#loader"}},[s._v("#")]),s._v(" loader")]),s._v(" "),a("p",[s._v("在手写模块打包代码之前，先学一学如何写一个 loader")]),s._v(" "),a("p",[s._v("Loader 就像一个翻译员，能将源文件经过转化后输出新的结果，并且一个文件还可以\n链式 地经过多个翻译员翻译。 以处理 scss 文件为例:")]),s._v(" "),a("p",[s._v("• 先将 scss 源代码提交给 sass-loader，将 scss 转换成 CSS;")]),s._v(" "),a("p",[s._v("• 将 sass-loader 输出的 css 提交给 css-loader 处理，找出 css 中依赖的资源、压缩\ncss 等；")]),s._v(" "),a("p",[s._v("• 将 css-loader 输出的 css 提交给 style-loader 处理，转换成通过脚本加载的 JavaScript 代码。")]),s._v(" "),a("h3",{attrs:{id:"分析一下-markdown-loader"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分析一下-markdown-loader"}},[s._v("#")]),s._v(" 分析一下 markdown-loader")]),s._v(" "),a("p",[s._v("https://github.com/peerigon/markdown-loader/blob/master/index.js")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('"use strict";\n\n//分析mark源码工具\nconst marked = require("marked");\n//webpack提供的工具集 收集用户options等 也就是webpack.**.js里module.export的配置等\nconst loaderUtils = require("loader-utils");\n\n//提供一个对外的函数\nmodule.exports = function (markdown) {\n    // merge params and default config\n    const options = loaderUtils.getOptions(this);\n    // 当前loader开启缓存\n    this.cacheable();\n    // 用户option---\x3emark\n    marked.setOptions(options);\n    //string\n    return marked(markdown);\n};\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h3",{attrs:{id:"实现一个-loader"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现一个-loader"}},[s._v("#")]),s._v(" 实现一个 loader")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const loaderUtils = require(\"loader-utils\");\n//this 代表当前loader类\nmodule.exports = function(contant) {\n    // merge params and default config\n    \n    const options = loaderUtils.getOptions(this);\n    //拿到options\n    console.log('前置的钩子函数' + this.data.value)\n    console.log('🌶️配置文件' + options.data)\n    //为了避免使用正则过于复杂 ----\x3east🌲\n    //content.replace('const','var')\n    //关 闭该 Loader 的缓存功能,默认缓存是开的\n    this.cacheable(false);\n    return contant + \"console.log(1111)\";\n};\n\n//挂载前置的钩子\n\nmodule.exports.pitch = function(r, prerequest, data) {\n    data.value = \"刘帅🏮\"\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const path = require('path');\nmodule.exports = {\n    module: {\n        rules: [{\n            test: /\\.js$/,\n            exclude: /(node_modules|bower_components)/,\n            use: {\n                loader: path.resolve('./loader/index.js'),\n                options: {\n                    data: \"🍌自定义配置项\"\n                }\n            }\n        }]\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h3",{attrs:{id:"补充"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#补充"}},[s._v("#")]),s._v(" 补充")]),s._v(" "),a("p",[s._v("Loader 有同步和异步之分，上面介绍的 Loader 都是同步的 Loader，因为它们的转换流 程都是同步 的，转换完成后再返回结果。但在某些场景下转换的步骤只能是异步完成的，例 如我们需要 通过网络请求才能得出结果，如果采用同步的方式，则网络请求会阻塞整个构建， 导致 构建非常缓慢。\n如果是异步转换，则我们可以这样做:")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("module . exports = function (source) {\n//告诉 Webpack 本次转换是异步 的， Loader 会在 callback 中回调结果\nvar callback= this.async() ;\nsomeAsyncOperation(source, function(err, result , sourceMaps, ast) {\n//通过 callback 返回异步执行后的结果\ncallback (err, result, sourceMaps, ast); } ) \n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("处理二进制数据")]),s._v(" "),a("p",[s._v("在默 认情况下， Webpack 传给 Loader 的原内容都是 UTF-8 格式编码的字符串。但在某 些场景下 Loader 不会处理文本文件，而会处理二进制文件如 file-loader，这时就需要 Webpack 为 Loader 传入二进制格式的数据。为此，我们需要这样编写 Loader:")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("module. exports = function (source) {\n//在 exports.raw=== true 时， \n//Webpack 传给 Loader 的 source 是 Buffer 类型的 \n\nsource instanceof Buffer === true;\n//Loader 返回的类型也可以是 Buffer 类型的\n//在 exports .raw !== true 时， Loader 也可以返回 Buffer 类型的结果\nreturn source;\n// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据 module .exports . raw = true;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h2",{attrs:{id:"webpack-打包后文件分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#webpack-打包后文件分析"}},[s._v("#")]),s._v(" Webpack 打包后文件分析")]),s._v(" "),a("p",[s._v("为了更好的理解 webpack 模块打包机制，我们先来看一下 webpack 打包后的文件。")]),s._v(" "),a("p",[s._v("对刚才打包后的文件分析")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('\n(function(modules) { // webpackBootstrap\n    // The module cache\n    //模块的缓存\n    var installedModules = {};\n\n    // The require function\n\n    function __webpack_require__(moduleId) {\n\n        // Check if module is in cache\n        //检查存模块，是否以缓存住模块\n        if (installedModules[moduleId]) {\n\n            return installedModules[moduleId].exports;\n\n        }\n        // Create a new module (and put it into the cache)\n        //创建新的缓存对象\n        var module = installedModules[moduleId] = {\n\n            i: moduleId,\n\n            l: false,\n\n            exports: {}\n\n        };\n\n        // Execute the module function\n        //执行入口函数\n        modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n        // Flag the module as loaded\n\n        // Return the exports of the module\n\n        return module.exports;\n\n    }\n    // Load entry module and return exports\n    //加载入口\n    return __webpack_require__(__webpack_require__.s = "./src/index.js");\n\n})\n({\n\n    "./src/index.js": (function(module, exports) {\n\n        console.log("我是入口文件");\n        console.log(1111)\n    })\n\n\n});\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br")])]),a("p",[s._v("上述代码主要由以下几个部分组成：")]),s._v(" "),a("p",[s._v("最外层是一个自执行函数")]),s._v(" "),a("p",[s._v("自执行函数会传递一个 modules 参数，这个参数是一个对象，{key: 文件路径,value: 函数}，value 中的函数内部是打包前模块的 js 代码。")]),s._v(" "),a("p",[s._v("内部自定义一个 "),a("strong",[s._v("webpack_require")]),s._v(" 执行器，用来执行导入的文件，并导出 exports。")]),s._v(" "),a("p",[s._v("实现了 common.js 规范，不发网络请求，把包打包到了自己身上\neval 编译快执行快")]),s._v(" "),a("p",[s._v("新建 src/async1.js")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("\n//async1.js\nconst async1 = 'webpack源码分析async1';\nexport default async1;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("//抽离出的 main.js")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('  (function(modules) {\n\n      var installedModules = {};\n\n      function __webpack_require__(moduleId) {\n\n          if (installedModules[moduleId]) {\n              return installedModules[moduleId].exports;\n          }\n          var module = installedModules[moduleId] = {\n              exports: {}\n          };\n          modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\n          return module.exports;\n      }\n\n      return __webpack_require__("./src/index.js");\n  })\n  ({\n\n      "./src/async1.js":\n\n          (function(module, __webpack_exports__, __webpack_require__) {\n          const async = `hello nihao`;\n          __webpack_exports__["default"] = (async)\n\n      }),\n\n      "./src/index.js":\n\n          (function(module, __webpack_exports__, __webpack_require__) {\n          var _async1__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__("./src/async1.js");\n          //import 就相当于 var async1 = __webpack_require__("./src/async1.js");\n          console.log(_async1__WEBPACK_IMPORTED_MODULE_0__["default"])\n\n      })\n\n  });\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("h2",{attrs:{id:"手写一个模块打包器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#手写一个模块打包器"}},[s._v("#")]),s._v(" 手写一个模块打包器")]),s._v(" "),a("h3",{attrs:{id:"整体流程分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#整体流程分析"}},[s._v("#")]),s._v(" 整体流程分析")]),s._v(" "),a("p",[s._v("1.读取入口文件")]),s._v(" "),a("p",[s._v("2.将内容转换为 ast 树")]),s._v(" "),a("p",[s._v("3.深度遍历语法树，找到所有的依赖，并加入到一个数组中。")]),s._v(" "),a("p",[s._v("4.将 ast 树转换为可执行 js 的代码")]),s._v(" "),a("p",[s._v("5 编写__webpack_require__函数，根据入口文件自动执行完所有的依赖。")]),s._v(" "),a("p",[s._v("根据上述步骤开始写代码😊")]),s._v(" "),a("p",[s._v("代码层分为四层")]),s._v(" "),a("p",[s._v("一层读取入口文件，将内容转化为 ast（抽象语法树）树，遍历语法树并将 import xxx from './xxx.js' 转化为 var xxx = "),a("strong",[s._v("webpack_require")]),s._v('("xxx"); 将 export default xxx 转化为 '),a("strong",[s._v("webpack_exports")]),s._v('["default"] = xxx')]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("function parse(filename) {\n    const contant = fs.readFileSync(filename, 'utf-8');\n    //将字符串转换为ast抽象语法树\n    const ast = parser.parse(contant, {\n            sourceType: 'module'\n        })\n        // console.log(ast)\n    const code = new MagicString(contant);\n    //遍历抽象语法树\n    traverse(ast, {\n        ExportDeclaration({\n            node\n        }) {\n            const {\n                start,\n                end,\n                declaration,\n            } = node;\n            code.overwrite(start, end,\n                `__webpack_exports__[\"default\"]=${declaration.name}`\n            )\n        },\n        ImportDeclaration({\n            node\n        }) {\n            // console.log('🌟🌟', node)\n            const {\n                start,\n                end,\n                specifiers,\n                source\n            } = node;\n            const newFile = \"./src/\" + path.join(source.value) + '.js';\n            code.overwrite(start, end,\n                `var ${specifiers[0].local.name}=__webpack_require__(\"${newFile}\").default`\n            )\n        }\n    })\n    const _code = code.toString()\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("p",[s._v("二层 深度遍历语法树，找到所有依赖并放入数组中，生成所有资源对象数组。")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    //  全局的依赖项\nconst dependencies = [];\n\nfunction parse(filename) {\n    const contant = fs.readFileSync(filename, 'utf-8');\n    //获取当前的依赖\n    const garphArray = [];\n    //将字符串转换为ast抽象语法树\n    const ast = parser.parse(contant, {\n            sourceType: 'module'\n        })\n        // console.log(ast)\n    const code = new MagicString(contant);\n    //遍历抽象语法树\n    traverse(ast, {\n        ExportDeclaration({\n            node\n        }) {\n            const {\n                start,\n                end,\n                declaration,\n            } = node;\n            code.overwrite(start, end,\n                `__webpack_exports__[\"default\"]=${declaration.name}`\n            )\n        },\n        ImportDeclaration({\n            node\n        }) {\n            // console.log('🌟🌟', node)\n            const {\n                start,\n                end,\n                specifiers,\n                source\n            } = node;\n            const newFile = \"./src/\" + path.join(source.value) + '.js';\n            code.overwrite(start, end,\n                `var ${specifiers[0].local.name}=__webpack_require__(\"${newFile}\").default`\n            )\n            garphArray.push(newFile);\n        }\n    })\n    const _code = code.toString()\n    dependencies.push({\n        filename,\n        _code\n    });\n    return garphArray;\n}\nlet garphArray = parse(entryPonint);\n//对其进行递归\nfor (let item of garphArray) {\n    parse(item)\n}\nconsole.log(dependencies)\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br")])]),a("p",[s._v("三层 封装自执行函数，创建 "),a("strong",[s._v("webpack_require")]),s._v(" 方法，处理文件相互依赖，该处引入 ejs 对模版处理")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('const template = `\n  (function (modules) {\n\n      var installedModules = {};\n\n      function __webpack_require__(moduleId) {\n          if (installedModules[moduleId]) {\n              return installedModules[moduleId].exports;\n          }\n          var module = installedModules[moduleId] = {\n              exports: {}\n          };\n          modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n          return module.exports;\n      }\n      return __webpack_require__("${entryPonint}");\n  })\n  ({\n\n    <% for(var i = 0; i < dependencies.length; i++){ %>\n        "<%-dependencies[i]["filename"]%>":\n        (function (module, __webpack_exports__, __webpack_require__) {\n               <%-dependencies[i]["_code"]%>\n            }),\n    <% } %>\n  });\n`;\n\nlet result = ejs.render(template, {\n    dependencies\n})\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[s._v("四层 将其 result 模版 写出")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('fs.writeFileSync("./dist/main.js", result)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"相关链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#相关链接"}},[s._v("#")]),s._v(" 相关链接")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/wendaoshuai66/diy-webpack",target:"_blank",rel:"noopener noreferrer"}},[s._v("git 仓库"),a("OutboundLink")],1)])])}),[],!1,null,null,null);n.default=r.exports}}]);
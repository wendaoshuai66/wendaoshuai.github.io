(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{243:function(s,a,e){"use strict";e.r(a);var n=e(0),t=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"pm2-项目部署总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pm2-项目部署总结"}},[s._v("#")]),s._v(" pm2 项目部署总结")]),s._v(" "),e("h2",{attrs:{id:"什么是-pm2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是-pm2"}},[s._v("#")]),s._v(" 什么是 pm2")]),s._v(" "),e("p",[s._v("pm2 是一个带有负载均衡功能的 Node 应用的进程管理器。pm2 是一个后台进程管理器。")]),s._v(" "),e("h2",{attrs:{id:"前台进程与后台进程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前台进程与后台进程"}},[s._v("#")]),s._v(" 前台进程与后台进程")]),s._v(" "),e("p",[s._v("1.前台进程是指项目启动进程之后，这个一直在终端中运行，不能关掉，关掉的话项目就会终止。像 supervisor 和 nodemon 就是前台进程管理。")]),s._v(" "),e("p",[s._v("2.后台进程是在计算机后台启动一个进行，不会在终端中显示，但是仍然启动。")]),s._v(" "),e("h2",{attrs:{id:"特性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#特性"}},[s._v("#")]),s._v(" 特性")]),s._v(" "),e("p",[s._v("内建负载均衡")]),s._v(" "),e("p",[s._v("后台运行")]),s._v(" "),e("p",[s._v("0 秒停机重启")]),s._v(" "),e("p",[s._v("具有 Ubuntu 和 CentOS 的启动脚本")]),s._v(" "),e("p",[s._v("停止不稳定的进程（避免无限循环）")]),s._v(" "),e("p",[s._v("控制台检测")]),s._v(" "),e("p",[s._v("提供 HTTP API")]),s._v(" "),e("p",[s._v("远程控制和实时的接口 API(Nodejs 模块，允许和 pm2 进程管理器交互)")]),s._v(" "),e("h2",{attrs:{id:"安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$ npm install pm2@latest -g\n# or\n$ yarn global add pm2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"目录介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#目录介绍"}},[s._v("#")]),s._v(" 目录介绍")]),s._v(" "),e("p",[s._v("pm2 安装好后，会自动创建下面目录。")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/usr/local/bin/pm2-docker -> /usr/local/lib/node_modules/pm2/bin/pm2-docker\n/usr/local/bin/pm2-dev -> /usr/local/lib/node_modules/pm2/bin/pm2-dev\n/usr/local/bin/pm2 -> /usr/local/lib/node_modules/pm2/bin/pm2\n/usr/local/bin/pm2-runtime -> /usr/local/lib/node_modules/pm2/bin/pm2-runtime\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h2",{attrs:{id:"pm2-的生态文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pm2-的生态文件"}},[s._v("#")]),s._v(" pm2 的生态文件")]),s._v(" "),e("p",[s._v("一般我们会在项目的根目录创建 pm2.json 文件，基本内容如下：")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n    "name" : "node-test",\n    "script" : "app.js",\n    "log_data_format" : "YYYY-MM-DD HH:mm Z",\n    //日志\n    "out_file" : "log/node-app.stdout.log",\n    "watch" : true,\n    "instances": "max",\n    "exec_mode" : "cluster"\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h3",{attrs:{id:"启动-pm2，可直接使用以下命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动-pm2，可直接使用以下命令"}},[s._v("#")]),s._v(" 启动 pm2，可直接使用以下命令")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 start pm2.json\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"环境变量的设置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#环境变量的设置"}},[s._v("#")]),s._v(" 环境变量的设置")]),s._v(" "),e("p",[s._v("pm2 生态文件中可使用 env_[name]的形式设置多个环境变量")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n    "name" : "node-app",\n    "script" : "app.js",\n    "log_data_format" : "YYYY-MM-DD HH:mm Z",\n    "out_file" : "log/node-app.stdout.log",\n    "watch" : true,\n    "instances": "max",\n    "exec_mode" : "cluster"\n    "env" : {\n        "NODE_ENV" : "development"\n    },\n    "env_production" : {\n        "NODE_ENV" :"production"\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("终端使用–env 参数指定环境")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 start pm2.json –env production\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("项目一旦启动环境变量就是定值，无法更改，如果非要更改可使用–update-env 来更改")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 restart pm2.json –update-env\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"进程管理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#进程管理"}},[s._v("#")]),s._v(" 进程管理")]),s._v(" "),e("p",[s._v("pm2 是一个保存在后台的进程，一个守护进程，负责处理您所有正在运行的进程。")]),s._v(" "),e("h2",{attrs:{id:"pm2-进程命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pm2-进程命令"}},[s._v("#")]),s._v(" pm2 进程命令")]),s._v(" "),e("p",[s._v("启动进程")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 start pm2.json\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("停止进程")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 stop node-test //node-test为启动进程名称\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 stop all //停止所有\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("重启进程")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 restart node-test\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("列出所有进程")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 ls\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("启动本地监控")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 monit\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("##pm2 的日志管理")]),s._v(" "),e("p",[s._v("pm2 的日志可以实时获取并存储在硬盘中，默认情况下保存在~/.pm2/logs 中")]),s._v(" "),e("p",[s._v("所有进程的实时日志")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 logs\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("可指定进程名称表示只查看单个进程的实时日志")]),s._v(" "),e("p",[s._v("清空日志")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 flush\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("用配置文件指定日志管理")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("{\n    \"name\": 'app',\n    \"script\": 'app.js',\n    \"output\": './out.log',\n    \"error\": './error.log',\n\t\"log\": './combined.outerr.log',\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("output 表示只是标准输出相当于 JavaScript 的 console.log()")]),s._v(" "),e("p",[s._v("error 表示只是错误输出相当于 JavaScript 的 console.error()")]),s._v(" "),e("p",[s._v("log 相当于上面两种的结合，默认是禁用的。")]),s._v(" "),e("p",[s._v("循环日志：pm2 install pm2-logrotate")]),s._v(" "),e("p",[s._v("##负载均衡")]),s._v(" "),e("p",[s._v("pm2 的负载均衡也可以称之为集群模式。")]),s._v(" "),e("p",[s._v("内置的负载平衡器提供联网的 Node.js 应用（http（s）/ tcp /udp 服务器），可在所有可用的 CPU 上进行缩放，无需修改任何代码。")]),s._v(" "),e("p",[s._v("命令如下，表示开启三个进程。如果-i 0，则会根据机器当前核数自动开启尽可能多的进程。")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 start app.js -i 3 # 开启三个进程\npm2 start app.js -i max # 根据机器CPU核数，开启对应数目的进程 \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("参考文档："),e("a",{attrs:{href:"https://pm2.keymetrics.io/docs/usage/cluster-mode/#automatic-load-balancing",target:"_blank",rel:"noopener noreferrer"}},[s._v("点击查看"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("##0 秒宕机重载")]),s._v(" "),e("p",[s._v("当使用 restart 时，pm2 会先杀死进程然后再重启进程，所以在短时间内无法启动服务，通过重载，pm2 会一一的重启所有进程，保证始终都有一个进程在运行。")]),s._v(" "),e("div",{staticClass:"language-plain line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("pm2 reload node-app 或者 pm2 reload pm2.json\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"参考"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://pm2.keymetrics.io/docs/advanced/pm2-module-system/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),e("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=t.exports}}]);
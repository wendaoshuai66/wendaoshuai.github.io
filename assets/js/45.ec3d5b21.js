(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{329:function(s,n,a){"use strict";a.r(n);var e=a(10),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"webpack-使用总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#webpack-使用总结"}},[s._v("#")]),s._v(" Webpack 使用总结")]),s._v(" "),n("h2",{attrs:{id:"前端的发展"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前端的发展"}},[s._v("#")]),s._v(" 前端的发展")]),s._v(" "),n("p",[s._v("近年来 Web 应用变得更加复杂与庞大， Web 前端技术的应用范围也更加广泛。通过直接编写 JavaScript、css、 HTML 开发 Web 应用的方式己经无法应对当前 Web 应用的发展 。 近年来，前端社区涌现出 许 多新思想与框架，下面将一一介绍它 们 。")]),s._v(" "),n("h3",{attrs:{id:"模块化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#模块化"}},[s._v("#")]),s._v(" 模块化")]),s._v(" "),n("p",[s._v("模块化是指将一个复杂的系统分解为多个模块，方便编码")]),s._v(" "),n("p",[s._v("很久以前，开发网页要通过命名空间的方式来组织代码，例如 jQuery 库将它的 API 都放 在了 window .$下，在加载完 jQue 町后，其他模块再通过 window . ♀去使用 jQuery。这样做 有很多问题，其中包括:")]),s._v(" "),n("p",[s._v("命名空间冲突，两个库可能会使用同一个名称，例如 Zepto (http://zeptojs.com)也 被放在 w 工 ndow.$下")]),s._v(" "),n("p",[s._v("无法合理地管理项目的依赖和版本")]),s._v(" "),n("p",[s._v("无法方便地控制依赖的加载顺序。")]),s._v(" "),n("p",[s._v("直白一些就是开发效率会低，维护成本会大。")]),s._v(" "),n("h4",{attrs:{id:"commonjs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#commonjs"}},[s._v("#")]),s._v(" CommonJS")]),s._v(" "),n("p",[s._v("CommonJS 是一种广泛应用的 Javascript 模块化规范，核心：")]),s._v(" "),n("p",[s._v("require 方法同步加载依赖的其他模块，")]),s._v(" "),n("p",[s._v("module.exports 导出需要的接口")]),s._v(" "),n("p",[s._v("CommonJS 的流行 的益于 node 采用该方式，后来这种方式被引入到网页中开发")]),s._v(" "),n("p",[s._v("采用 CommonJS 导入及导出的代码如下:")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("// 导入\nconst moduleA = require ( ’. / moduleA ’); // 导出\nmodule .exports = moduleA.someFunc;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("CommonJS 的优点在于:")]),s._v(" "),n("p",[s._v("1.代码可复用于 Node.js 环境中，例如做同构")]),s._v(" "),n("p",[s._v("2.通过 npm 发布的很多第三方模块都采用了，CommonJS 规范。")]),s._v(" "),n("p",[s._v("缺点：")]),s._v(" "),n("p",[s._v("1.不能直接在浏览器环境中运行，必须通过工具转换为 ES5 的标准")]),s._v(" "),n("p",[s._v("历史")]),s._v(" "),n("p",[s._v("CommonJS 还可以细分为 CommonJSl 和 CommonJS2")]),s._v(" "),n("p",[s._v("CommonJS1 和 CommonJS2 区别：")]),s._v(" "),n("p",[s._v("CommonJS1 只能通过 exports . XX = XX 导出")]),s._v(" "),n("p",[s._v("CommonJS2 在 CommonJSl 的基础上加入了 module. exports = XX")]),s._v(" "),n("h4",{attrs:{id:"amd"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#amd"}},[s._v("#")]),s._v(" AMD")]),s._v(" "),n("p",[s._v("AMD 也是一种 JavaScript 模块化规范。")]),s._v(" "),n("p",[s._v("AMD 与 CommonJS 区别：AMD 采用了异步的方式去加载依赖的模块。")]),s._v(" "),n("p",[s._v("AMD 主要用于解决针对浏览器环境的模块化问题，最具代表性的实现是 requirejs。")]),s._v(" "),n("p",[s._v("采用 AMD 导入及导出的代码如下:")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("采用 AMD 导入及导出的代码如下:\n// 定义一个模块\ndefine (’ module ’ , [ ’ dep ’] , function (dep) {\nrequirejs\n(http://\nreturn exports;\n});\n//导入和使用\nrequire ([’module’] , });\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("AMD 的优点在于:")]),s._v(" "),n("p",[s._v("1.可在不转换代码的情况下直接在浏览器环境中运行")]),s._v(" "),n("p",[s._v("2.异步加载依赖")]),s._v(" "),n("p",[s._v("3.可以并行加载多个依赖")]),s._v(" "),n("p",[s._v("4.代码可以在浏览器环境中与 Node 环境中运行")]),s._v(" "),n("p",[s._v("AMD 的优点在于:")]),s._v(" "),n("p",[s._v("JavaScript 运行环境没有原生支持 AMD。， 需要先导入实现了 AMD 的库 后才能正常使用。")]),s._v(" "),n("h4",{attrs:{id:"es6-模块化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#es6-模块化"}},[s._v("#")]),s._v(" ES6 模块化")]),s._v(" "),n("p",[s._v("ES6 模块化是国际标准化组织 ECMA 提出的 JavaScript 模块化规范，它在 语言层面上实 现了模块化。浏览器厂商和 Node. 都宣布要原生支持该规范 。 它将逐渐取代 CommonJS 和 AMD 规范，成为浏览器和服务器通用的模块解决方案 。")]),s._v(" "),n("p",[s._v("采用 ES6 模块化导入及导出的代码如下:")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("//导 入\nimport { readFile } from ’ fs ’; import React from ’react’; //导出\nexport function hello {) {};\n\nexport default {\n\n...\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"常见的构建工具及对比"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#常见的构建工具及对比"}},[s._v("#")]),s._v(" 常见的构建工具及对比")]),s._v(" "),n("h4",{attrs:{id:"gulp"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gulp"}},[s._v("#")]),s._v(" Gulp")]),s._v(" "),n("p",[s._v("Gulp 是基于流的自动化构建工具。可以管理和执行任务。还可以支持监听文件，与读写文件")]),s._v(" "),n("p",[s._v("Gulp 被设计得非常简单，只通过下面 5 种方法就可以支持几乎 所有构建场景:")]),s._v(" "),n("p",[s._v("1.gulp.task 注册任务")]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[s._v("gulp.run 执行任务")])]),s._v(" "),n("p",[s._v("3.gulp.watch 监听任务")]),s._v(" "),n("p",[s._v("4.gulp.src 读取文件")]),s._v(" "),n("p",[s._v("5.gulp.dest 写文件")]),s._v(" "),n("p",[s._v("举个例子 Gulp 和 Rollup 实现了对数据的流清洗")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("const gulp = require('gulp');\nconst watch = require('gulp-watch');\nconst rollup = require('gulp-rollup');\nconst babel = require('gulp-babel');\nconst replace = require('rollup-plugin-replace')\nconst entry = './src/server/**/*.js';\nconst clearEntry = [\"./src/server/config/index.js\"]\n\n\nfunction buildenv() {\n    return watch(entry, { ignoreInitial: false }, function() {\n            gulp.src(entry)\n                .pipe(babel({\n                    //非常重要一点，涉及到自己独立的编译，外面的留给前端\n                    babelrc: false,\n                    \"plugins\": [\n                        [\"@babel/plugin-proposal-decorators\", { \"legacy\": true }],\n                        \"@babel/plugin-transform-modules-commonjs\"\n                    ]\n                })).pipe(gulp.dest('dist'))\n        })\n        // .pipe(gulp.dest('dist')); 放外面监测不到，有点毛病 😔\n\n}\n//与开发没有多大区别，只不过要加一个流式清洗\nfunction buildprod() {\n\n    return gulp.src(entry)\n        .pipe(babel({\n            //非常重要一点，涉及到自己独立的编译，外面的留给前端\n            babelrc: false,\n            ignore: clearEntry,\n            \"plugins\": [\n                [\"@babel/plugin-proposal-decorators\", { \"legacy\": true }],\n                \"@babel/plugin-transform-modules-commonjs\"\n            ]\n        })).pipe(gulp.dest('dist'))\n}\n\nfunction buildconfig() {\n    return gulp.src(entry)\n        .pipe(rollup({\n            //注意一点要编译成commonjs\n            output: {\n                format: \"cjs\"\n            },\n            input: clearEntry,\n            //由于打包后，对process.env.NODE_ENV没有处理\n            plugins: [\n                replace({\n                    \"process.env.NODE_ENV\": JSON.stringify('production')\n                })\n            ]\n        }))\n        .pipe(gulp.dest('./dist'));\n}\n\nfunction lint() {\n\n}\nlet build = gulp.series(buildenv)\n\nif (process.env.NODE_ENV == 'lint') {\n    build = gulp.series(lint)\n}\nif (process.env.NODE_ENV == 'production') {\n    build = gulp.series(buildprod, buildconfig)\n}\ngulp.task(\"default\", build)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br")])]),n("h4",{attrs:{id:"webpack"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#webpack"}},[s._v("#")]),s._v(" Webpack")]),s._v(" "),n("p",[s._v("Webpack 是一个打包模块化 js 的工具🔧，在 Webpack 中一切皆模块，通过 loader 转化文件，通过 Plugin 注入钩子，最后输出由多个模块组合成的文件📃。")]),s._v(" "),n("p",[s._v("一切文件如 JavaScript、 css、 scss、图片、模板，对于 Webpack 来说都是一个个模块")]),s._v(" "),n("h4",{attrs:{id:"rollup"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rollup"}},[s._v("#")]),s._v(" Rollup")]),s._v(" "),n("p",[s._v("Rollup (https://rollupjs.org)是一个和 Webpack 很类似但专注于 ES6 的模块打包工具。它 的亮点 在于，能针对 ES6 源码进行 Tree Shaking，以去除那些己被定义但没被使用的代码 并进 行 Scope Hoisting，以减小输出 文件的大 小和提升运行性能 。然而 Rollup 的这些亮点随后就被 Webpack 模仿和实现。由于 Rollup 的使用方法和 Webpack 差不多 ，所以这里就不详细介绍如 何使用 Rollup 了，而是详细说明它们的差别:")]),s._v(" "),n("p",[s._v("• Rollup 是在 Webpack 流行后出 现的替代品")]),s._v(" "),n("p",[s._v("• Rollup 生态链还不完善，体验不 如 Webpack\n• Rollup 的功能不如 Webpack 完善 ，但其配置和使用更简单")]),s._v(" "),n("p",[s._v("• Rollup 不支持 CodeSpliting，但好处是在打包出来的代码中没有 Webpack 那段模块 的加载、执行和缓存的代码")]),s._v(" "),n("h2",{attrs:{id:"整体流程分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#整体流程分析"}},[s._v("#")]),s._v(" 整体流程分析")]),s._v(" "),n("h5",{attrs:{id:"第一步-执行-webpack-函数-在-webpack-函数中初始化-compiler-对象-new-compiler-options-context-初始化自定义插件-plugin-apply-compiler"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第一步-执行-webpack-函数-在-webpack-函数中初始化-compiler-对象-new-compiler-options-context-初始化自定义插件-plugin-apply-compiler"}},[s._v("#")]),s._v(" 第一步，执行 webpack 函数，在 webpack 函数中初始化 compiler 对象 new Compiler(options.context)，初始化自定义插件 plugin.apply(compiler)")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v('const webpack = (options, callback) => {\n\tlet compiler;\n\tif (typeof options === "object") {\n\t\toptions = new WebpackOptionsDefaulter().process(options);\n\t\t//创建编译对象\n\t\tcompiler = new Compiler(options.context);\n\t\tcompiler.options = options;\n\t\t\n\t\t\n\t\t//将Node.js格式的文件系统应用于compiler。\n\t\tnew NodeEnvironmentPlugin({\n\t\t\tinfrastructureLogging: options.infrastructureLogging\n\t\t}).apply(compiler);\n\t\tif (options.plugins && Array.isArray(options.plugins)) {\n\t\t\tfor (const plugin of options.plugins) {\n\t\t\t// 执行自定义插件\n\t\t\t\tif (typeof plugin === "function") {\n\t\t\t\t\tplugin.call(compiler, compiler);\n\t\t\t\t} else {\n\t\t\t\t\n\t\t\t\t\tplugin.apply(compiler);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t//触发environment钩子函数：在准备环境之前运行插件。\n\t\tcompiler.hooks.environment.call();\n\t\t// 触发afterEnvironment钩子函数：执行插件环境设置完成。\n\t\tcompiler.hooks.afterEnvironment.call();\n\t\t//处理配置中的target参数，例如 web，node，根据不同配置，配置默认的plugin。\n\t\tcompiler.options = new WebpackOptionsApply().process(options, compiler);\n\t} \n\tif (callback) {\n\t // 开始编译\n\t\tcompiler.run(callback);\n\t}\n\t// 返回compiler\n\treturn compiler;\n};\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br")])]),n("p",[s._v("compiler.run(callback）执行后，就会根据生命周期，执行对应的事件钩子函数")]),s._v(" "),n("h5",{attrs:{id:"第二步-触发-webpackoptionsapply-中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第二步-触发-webpackoptionsapply-中间件"}},[s._v("#")]),s._v(" 第二步，触发 WebpackOptionsApply 中间件")]),s._v(" "),n("p",[s._v("在 compilation 阶段会记录好依赖的工厂类。")]),s._v(" "),n("p",[s._v("在 make 阶段的时候会创建一个 SingleEntryPlugin 实例。")]),s._v(" "),n("p",[s._v("调用 compilation.addEntry 方法。")]),s._v(" "),n("p",[s._v("addEntry 会调用 _addModuleChain 方法，最终经过几次调用后会进入到 NormalModule.js 中的 build 方法。")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v('class WebpackOptionsApply extends OptionsApply {\n    process(options, compiler) {\n         ...\n        if (typeof options.target === "string") {\n            let JsonpTemplatePlugin;\n            let FetchCompileWasmTemplatePlugin;\n            let ReadFileCompileWasmTemplatePlugin;\n            let NodeSourcePlugin;\n            let NodeTargetPlugin;\n            let NodeTemplatePlugin;\n\n            switch (options.target) {\n                case "web":\n                    ...\n                    break;\n                case "webworker":\n                    {\n                    ....\n                        break;\n                    }\n                case "node":\n                case "async-node":\n                  ...\n                    break;\n                case "node-webkit":\n                ...\n                    break;\n                case "electron-main":\n\n                    break;\n                case "electron-renderer":\n                case "electron-preload":\n\n                    break;\n\n            }\n        }\n        ...\n        new EntryOptionPlugin().apply(compiler);\n        ...\n    }\n}\n\nmodule.exports = WebpackOptionsApply;\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br")])]),n("p",[s._v("上述代码 new EntryOptionPlugin().apply(compiler) 的时候会创建一个 SingleEntryPlugin 实例。")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("// WebpackOptionsApply -> EntryOptionPlugin ->SingleEntryPlugin\nclass SingleEntryPlugin {\n  apply(compiler) {\n    compiler.hooks.compilation.tap(\n      'SingleEntryPlugin',\n      (compilation, { normalModuleFactory }) => {\n        compilation.dependencyFactories.set(\n          SingleEntryDependency,\n          normalModuleFactory\n        );\n      }\n    );\n    compiler.hooks.make.tapAsync(\n      'SingleEntryPlugin',\n      (compilation, callback) => {\n        const { entry, name, context } = this;\n        const dep = SingleEntryPlugin.createDependency(entry, name);\n        compilation.addEntry(context, dep, name, callback);\n      }\n    );\n  }\n  static createDependency(entry, name) {\n    const dep = new SingleEntryDependency(entry);\n    dep.loc = { name };\n    return dep;\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("调用 compilation.addEntry 方法。")]),s._v(" "),n("p",[s._v("addEntry 会调用 _addModuleChain 方法，最终经过几次调用后会进入到 NormalModule.js 中的 build 方法。")]),s._v(" "),n("h5",{attrs:{id:"第三步-调用-normalmodule-中的-build-方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第三步-调用-normalmodule-中的-build-方法"}},[s._v("#")]),s._v(" 第三步，调用 NormalModule 中的 build 方法")]),s._v(" "),n("p",[s._v("build 方法会先执行 doBuild，将原始代码经过 loader 进行转义。")]),s._v(" "),n("p",[s._v("经过 doBuild 之后，我们的任何模块都被转成了标准的 JS 模块，那么下面我们就可以编译 JS 了")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("doBuild(options, compilation, resolver, fs, callback) {\n  const loaderContext = this.createLoaderContext(\n    resolver,\n    options,\n    compilation,\n    fs\n  );\n  // 执行loaders\n  runLoaders(\n    {\n        resource: this.resource,\n        loaders: this.loaders,\n        context: loaderContext,\n        readResource: fs.readFile.bind(fs)\n    },\n    (err, result) => {\n      if (result) {\n          this.buildInfo.cacheable = result.cacheable;\n          this.buildInfo.fileDependencies = new Set(result.fileDependencies);\n          this.buildInfo.contextDependencies = new Set(\n              result.contextDependencies\n          );\n      }\n      // result 是一个数组，数组的第一项就是编译后的代码\n      const resourceBuffer = result.resourceBuffer;\n      const source = result.result[0];\n      const sourceMap = result.result.length >= 1 ? result.result[1] : null;\n      const extraInfo = result.result.length >= 2 ? result.result[2] : null;\n      // this._source 是一个 对象，有name和value两个字段，name就是我们的文件路径，value就是 编译后的JS代码\n      this._source = this.createSource(\n          this.binary ? asBuffer(source) : asString(source),\n          resourceBuffer,\n          sourceMap\n      );\n      return callback();\n    }\n  );\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("h5",{attrs:{id:"第四步-调用-parser-parse-方法-将代码转换成-ast。-使用-parser-分析项目依赖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第四步-调用-parser-parse-方法-将代码转换成-ast。-使用-parser-分析项目依赖"}},[s._v("#")]),s._v(" 第四步，调用 parser.parse 方法，将代码转换成 ast。 使用 Parser 分析项目依赖")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("build(options, compilation, resolver, fs, callback) {\n  return this.doBuild(options, compilation, resolver, fs, err => {\n    // 编译成ast\n    const result = this.parser.parse(\n      this._ast || this._source.source(),\n      {\n          current: this,\n          module: this,\n          compilation: compilation,\n          options: options\n      },\n      (err, result) => {\n          if (err) {\n              handleParseError(err);\n          } else {\n              handleParseResult(result);\n          }\n      }\n    );\n  });\n}\n\nstatic parse(code, options) {\n  let ast;\n  let error;\n  let threw = false;\n  try {\n      // 编译成ast\n      ast = acorn.parse(code, parserOptions);\n  } catch (e) {\n      error = e;\n      threw = true;\n  }\n  return ast;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("h5",{attrs:{id:"第五步-解析完-ast-后-就会对每个模块所依赖的对象进行收集"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第五步-解析完-ast-后-就会对每个模块所依赖的对象进行收集"}},[s._v("#")]),s._v(" 第五步，解析完 ast 后，就会对每个模块所依赖的对象进行收集")]),s._v(" "),n("p",[s._v("如果我们有 import a from 'a.js' 这样的语句，那么经过 babel-loader 之后会变成 var a = require('./a.js') ，而对这一句的处理就在 walkStatements 中，这里经过了几次跳转，最终会发现进入了 walkVariableDeclarators 方法，这里我们这是声明了一个 a 变量。这个方法的主要内容如下：")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("// import a from 'a.js'\nwalkVariableDeclaration(statement) {\n  for (const declarator of statement.declarations) {\n    switch (declarator.type) {\n      case \"VariableDeclarator\": {\n        // 这里就是我们的变量名 a\n        this.walkPattern(declarator.id);\n        // 这里就是我们的表达式 `require('./a.js')`\n        if (declarator.init) this.walkExpression(declarator.init);\n        break;\n      }\n    }\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("这里的 require('./a.js') 是一个函数调用，在这里就会创建一个依赖，记录下对 a.js 模块的依赖关系，最终这些依赖会被放到 module.dependencies 中")]),s._v(" "),n("h5",{attrs:{id:"在收集完所有依赖之后-会调用-compilation-seal-方法。-使用-template-生成结果代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#在收集完所有依赖之后-会调用-compilation-seal-方法。-使用-template-生成结果代码"}},[s._v("#")]),s._v(" 在收集完所有依赖之后，会调用 compilation.seal 方法。 使用 Template 生成结果代码")]),s._v(" "),n("p",[s._v("遍历所有的 chunk 和 chunk 所依赖的文件。")]),s._v(" "),n("p",[s._v("将这些文件通过调用 MainTemplate 中的 render 生成最终代码。")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v('// 将结果包裹到一个IIFE中\nrenderBootstrap(hash, chunk, moduleTemplate, dependencyTemplates) {\n  const buf = [];\n  buf.push(\n    this.hooks.bootstrap.call(\n      "",\n      chunk,\n      hash,\n      moduleTemplate,\n      dependencyTemplates\n    )\n  );\n  buf.push(this.hooks.localVars.call("", chunk, hash));\n  buf.push("");\n  buf.push("// The require function");\n  buf.push(`function ${this.requireFn}(moduleId) {`);\n  buf.push(Template.indent(this.hooks.require.call("", chunk, hash)));\n  buf.push("}");\n  buf.push("");\n  buf.push(\n    Template.asString(this.hooks.requireExtensions.call("", chunk, hash))\n  );\n  buf.push("");\n  buf.push(Template.asString(this.hooks.beforeStartup.call("", chunk, hash)));\n  buf.push(Template.asString(this.hooks.startup.call("", chunk, hash)));\n  return buf;\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("h2",{attrs:{id:"webpack-整体流程分析总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#webpack-整体流程分析总结"}},[s._v("#")]),s._v(" webpack 整体流程分析总结")]),s._v(" "),n("h3",{attrs:{id:"流程概括"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#流程概括"}},[s._v("#")]),s._v(" 流程概括")]),s._v(" "),n("p",[s._v("1.初始化参数（得到参数）：")]),s._v(" "),n("p",[s._v("从配置文件（webpack.config.js）中与 shell 语句中读取与合并参数，得出最终的参数。")]),s._v(" "),n("p",[s._v("2.开始编译：")]),s._v(" "),n("p",[s._v("用上一步中的得到的参数初始化 Compiler 对象，加载所有配置插件，通过执行对象的 run 方法开始执行编译 。")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v('new Compiler(初始化得到的最终参数)；\n\n//通过apply 加载所有配置插件\nfor (const plugin of options.plugins) {\n\t\t\t// 执行自定义插件\n\t\t\t\tif (typeof plugin === "function") {\n\t\t\t\t\tplugin.call(compiler, compiler);\n\t\t\t\t} else {\n\t\t\t\t\n\t\t\t\t\tplugin.apply(compiler);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n//执行对象的run 方法开始执行编译\ncompiler.run(callback);\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("3.确定入口：")]),s._v(" "),n("p",[s._v("根据配置中的 entry 找出所有入口文件 。")]),s._v(" "),n("p",[s._v("WebpackOptionsApply -> EntryOptionPlugin ->SingleEntryPlugin")]),s._v(" "),n("p",[s._v("4.编译模块:\n从入口文件出发，开始 compilation 过程，调用所有配置的 Loader 对模块进行翻译，再将编译好的文件内容解析成 AST 静态语法树，再找出该\n模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理 。")]),s._v(" "),n("p",[s._v("5.完成模块编译")]),s._v(" "),n("p",[s._v("经过第 4 步使用 Loader 翻译完所有模块后，生成 AST 语法树，在 AST 语法树中可以分析到模块之间的依赖关系，对应做出优化。")]),s._v(" "),n("p",[s._v("6.输出资源")]),s._v(" "),n("p",[s._v("将所有模块中的 require 语法替换成__webpack_require__来模拟模块化操作。")]),s._v(" "),n("p",[s._v("7.最后把所有的模块打包进一个自执行函数（IIFE）中。")]),s._v(" "),n("h3",{attrs:{id:"流程图"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#流程图"}},[s._v("#")]),s._v(" 流程图")]),s._v(" "),n("p",[s._v("这张图画的很好，把 webpack 的流程画的很细致。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://wendaoshuai66.github.io/study/note/images/webpack_%E6%B5%81%E7%A8%8B%E5%9B%BE.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"编写插件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写插件"}},[s._v("#")]),s._v(" 编写插件")]),s._v(" "),n("h3",{attrs:{id:"一个最基础的-plugin-的代码是这样的"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一个最基础的-plugin-的代码是这样的"}},[s._v("#")]),s._v(" 一个最基础的 Plugin 的代码是这样的")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v('class basePlugin {\n    constructor(options){\n        //用户自定义配置\n        this.options = options\n        console.log(this.options)\n    }\n    apply(compiler) {\n        console.log("This is my first plugin.")\n    }\n}\n\nmodule.exports = basePlugin\n\n\nconst BasicPlugin =require (’./BasicPlug工n. j s ’); \nmodule.export = {\n\n    plugins:[\n     new. BasicPlugin();\n    ]\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("Webpack 启动后")]),s._v(" "),n("p",[s._v("1.在读取配置的过程中会先执行 new BasicPlugin(options )，初始化一个 BasicPlugin 并获得其实例。\n2.在初始化 compiler 对象后，")]),s._v(" "),n("p",[s._v("3.再调用 basicPlugin.apply (compiler)为插件实例传入 compiler 对象。")]),s._v(" "),n("p",[s._v("4.插件实例在获取到 compiler 对象后， 就可以通过 compiler.plugin (事件名称，回调函数)监听到 Webpack 广播的事件， 并且可以通过 compiler 对象去操作 Webpack.")]),s._v(" "),n("p",[s._v("这就是最简单的 Plugin😊， 但在实际开发中还 有很多细节需要注意 ，下面进行详细介绍。")]),s._v(" "),n("h3",{attrs:{id:"到底-compiler-和-compilation-是什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#到底-compiler-和-compilation-是什么"}},[s._v("#")]),s._v(" 到底 Compiler 和 Compilation 是什么")]),s._v(" "),n("p",[s._v("开发 Plugin 时最常用的两个对象就是 Compiler 和 Compilation，它们是 Plugin 和 Webpack\n之间的桥梁。 Compiler 和 Compilation 的含义如下。")]),s._v(" "),n("p",[s._v("Compiler 对象包含了 Webpack 环境的所有配置信息，包含 options、loaders、plugins 等信息。这个对象在 Webpack 启动时被实例化，它是全局唯一的，可以简单地将 它理解为 Webpack 实例。")]),s._v(" "),n("p",[s._v("Compiler-----》 Webpack 实例")]),s._v(" "),n("p",[s._v("Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。当 Webpack 以开发模式运行时，每当检测到一个文件发生变化，便有一次新的 Compilation 被\n创建 。 Compilation 对象也提供了很多事件回调供插件进行扩展。通过 Compilation 也能读取到 Compiler 对象。")]),s._v(" "),n("p",[s._v("Compiler 和 Compilation 的区别在于: Compiler 代表了整个 Webpack 从启动到关闭的生命周期，而 Compilation 只代表一次新的编译。")]),s._v(" "),n("h3",{attrs:{id:"温习一下-webpack-事件流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#温习一下-webpack-事件流"}},[s._v("#")]),s._v(" 温习一下 webpack 事件流")]),s._v(" "),n("p",[s._v("webpack 就像是我们工厂中流水线，要经过一系列的流程才会把我们的源码转化成输出结果 。在这条流水线当中每个处理流程的职责都是单一的，多个流程之间存在依赖关系，只有在完成当前处理后才能提交给下一个流程去处理。插件就像插入生产线中的某个功能，在特定的时机对生产线上的资源进行处理。")]),s._v(" "),n("p",[s._v("Webpack 通过 Tapable "),n("a",{attrs:{href:"https://github.com/webpack/tapable",target:"_blank",rel:"noopener noreferrer"}},[s._v("(https://github.com/webpack/tapable)"),n("OutboundLink")],1),s._v("来组织这条复杂的流水线。 Webpack 在运行的过程中会广播事件，插件只需要监听它所关心的事件，就能加入这条生产线中，去改变流水线的运作。 Webpack 的事件流机制保证了插件的有序性，使得整个系统的扩展性良好。")]),s._v(" "),n("p",[s._v("Webpack 的事件流机制应用了观察者模式，和 Node 扣中的 EventEmitter 非常相似 。Compiler 和 Compilation 都继承自 Tapable，可以直接在 Compiler 和 Compilation 对象上广播和监昕事 件，方法如下:")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("/**\n*广播事件\n食 event-name 为事件名称，注意不要和现有的事件重名 * params 为附带的参数\n*/\ncompiler.apply ’event-name’, params);\n/**\n*监昕名称为 event-name 的事件，当 event-name 事件发生时，函数就会被执行 。 *同时函数中的 params 参数为广播事件时附带的参数 。\n*/\ncompiler.plugin (’event-name’, function (params) {\n\n} ) ,\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("class SyncHook{\n    constructor(){\n        this.hooks = {}\n    }\n\n    // 订阅事件\n    tap(name, fn){\n    \n        this.hooks[name] = [fn]\n    }\n\n    // 发布\n    call(){\n        this.hooks[name].forEach(fn=>fn())\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h3",{attrs:{id:"实战剖析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实战剖析"}},[s._v("#")]),s._v(" 实战剖析")]),s._v(" "),n("p",[s._v("来看一看已经被众人玩坏的 html-webpack-plugin")]),s._v(" "),n("div",{staticClass:"language-plain line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-plain"}},[n("code",[s._v("const pluginName = 'ConsoleLogOnBuildWebpackPlugin';\n\n\nlet assetsHelp = (data) => {\n    let js = [];\n    let css = [];\n    let dir = {\n        js: item => `<script src=\"${item}\" class=\"lazyload-js\" type=\"module\"><\/script>`,\n        css: item => `<link rel=\"stylesheet\" href=\"${item}\">`\n    }\n    for (let jsitem of data.js) {\n        js.push(dir.js(jsitem))\n    }\n    for (let cssitem of data.css) {\n        css.push(dir.js(cssitem))\n    }\n    return {\n        js,\n        css\n    }\n}\n\n\nclass ConsoleLogOnBuildWebpackPlugin {\n    apply(compiler) {\n        compiler.hooks.compilation.tap(pluginName, compilation => {\n\n            compilation.hooks.htmlWebpackPluginAfterHtmlProcessing.tap(pluginName, (webpackPluginData) => {\n                console.log('🍎🍎🍎🍎🍎', webpackPluginData.assets)\n                let _html = webpackPluginData.html;\n                let result = assetsHelp(webpackPluginData.assets)\n                _html = _html.replace(/@components/g, '../../../components');\n                _html = _html.replace('\x3c!--injectjs--\x3e', result.js.join(''));\n                _html = _html.replace('\x3c!--injectcss--\x3e', result.css.join(''));\n                webpackPluginData.html = _html;\n            })\n        });\n\n    }\n}\nmodule.exports = ConsoleLogOnBuildWebpackPlugin;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);